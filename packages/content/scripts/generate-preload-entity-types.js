#!/usr/bin/env node
/**
 * Reads packages/content/entities.yaml and generates preload-entity-types.ts
 * with PRELOAD_ENTITY_TYPES = list of entity_type_id keys. Run at build time
 * so the web app can import the list for texture preloading.
 */

const fs = require("fs");
const path = require("path");

const ROOT = path.resolve(__dirname, "..");
const YAML_PATH = path.join(ROOT, "entities.yaml");
const OUT_PATH = path.join(ROOT, "preload-entity-types.ts");

function extractEntityTypeIds(yamlContent) {
  const ids = [];
  const lines = yamlContent.split(/\r?\n/);
  let inEntityTypes = false;
  for (const line of lines) {
    if (/^\s*entity_types\s*:/.test(line)) {
      inEntityTypes = true;
      continue;
    }
    if (!inEntityTypes) continue;
    // Top-level keys under entity_types are two spaces then key then colon
    const match = line.match(/^\s{2}([a-zA-Z_][a-zA-Z0-9_]*)\s*:/);
    if (match) {
      ids.push(match[1]);
    } else if (line.trim() === "" || line.startsWith("#")) {
      continue;
    } else if (line.match(/^\s{2,}/) && !match) {
      // still in a block, skip (nested key)
      continue;
    } else {
      // less indent = we left entity_types
      break;
    }
  }
  return ids;
}

function main() {
  const yamlContent = fs.readFileSync(YAML_PATH, "utf8");
  const ids = extractEntityTypeIds(yamlContent);
  if (ids.length === 0) {
    throw new Error("No entity_types found in entities.yaml");
  }
  const tsContent = `// Generated by scripts/generate-preload-entity-types.js â€” do not edit by hand.
// Source: entities.yaml (entity_types keys).

export const PRELOAD_ENTITY_TYPES = ${JSON.stringify(ids)} as const;

export type PreloadEntityTypeId = (typeof PRELOAD_ENTITY_TYPES)[number];
`;

  fs.writeFileSync(OUT_PATH, tsContent, "utf8");
  console.log(`Wrote ${OUT_PATH} with types: ${ids.join(", ")}`);
}

main();
